<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>clapety-clap üëè</title>
  
  
  
  <style>
  :root { --bg:#0f1115; --bg-alt:#161a21; --border:#2a303b; --text:#e6ecf3; --text-dim:#9aa4b1; --accent:#4f8cff; --accent-grad:linear-gradient(135deg,#4f8cff,#8950ff 60%); --radius:14px; --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; color-scheme:dark light; }
  /* Light theme override (applied via .light class OR user system preference) */
  body.light { --bg:#f6f7f9; --bg-alt:#ffffff; --border:#dbe1e8; --text:#1d2125; --text-dim:#5c6773; }
  @media (prefers-color-scheme: light){ :root { --bg:#f6f7f9; --bg-alt:#ffffff; --border:#dbe1e8; --text:#1d2125; --text-dim:#5c6773; } }
    body { background:var(--bg); color:var(--text); margin:0; font-family:system-ui,'Inter','Segoe UI',Roboto,Helvetica,Arial,sans-serif; -webkit-font-smoothing:antialiased; }
    .page { max-width:1040px; margin:0 auto; padding:clamp(1.2rem,2vw,2.4rem); }
    header { display:flex; flex-wrap:wrap; gap:1.5rem; align-items:flex-end; }
    h1 { font-size:clamp(1.9rem,4vw,2.6rem); margin:0; background:var(--accent-grad); -webkit-background-clip:text; background-clip:text; color:transparent; line-height:1.1; }
    p.lead { font-size:clamp(.95rem,1.2vw,1.05rem); max-width:640px; margin:.6rem 0 0; color:var(--text-dim); }
    .toolbar { margin-left:auto; display:flex; align-items:center; gap:.75rem; }
    button.switch { background:var(--bg-alt); border:1px solid var(--border); color:var(--text-dim); font-size:.7rem; padding:.55rem .85rem; border-radius:999px; letter-spacing:.5px; cursor:pointer; }
    button.switch:hover { color:var(--text); border-color:var(--accent); }
    main { margin-top:2rem; display:grid; gap:2rem; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
    section.panel { background:var(--bg-alt); border:1px solid var(--border); border-radius:var(--radius); padding:1.3rem 1.4rem 1.6rem; position:relative; overflow:hidden; backdrop-filter:blur(6px) saturate(150%); }
    section.panel:before { content:""; position:absolute; inset:0; background:radial-gradient(at 20% 25%,#ffffff08,transparent 60%),radial-gradient(at 80% 80%,#ffffff05,transparent 70%); pointer-events:none; }
    section.panel h2 { margin:0 0 1rem; font-size:1rem; letter-spacing:.5px; font-weight:600; text-transform:uppercase; color:var(--text-dim); }
    form { display:flex; flex-direction:column; gap:1rem; }
    label.field { display:flex; flex-direction:column; gap:.35rem; font-size:.72rem; letter-spacing:.5px; font-weight:600; color:var(--text-dim); text-transform:uppercase; }
    input[type="text"],input[type="number"] { background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:.75rem .85rem; font:inherit; color:var(--text); }
    input[type="text"]:focus,input[type="number"]:focus { outline:1px solid var(--accent); border-color:var(--accent); }
    .dropzone { position:relative; border:2px dashed var(--border); border-radius:14px; padding:1.75rem 1.25rem; text-align:center; display:flex; flex-direction:column; gap:.7rem; background:linear-gradient(145deg,var(--bg-alt),var(--bg) 70%); cursor:pointer; transition:border-color .25s, background .25s; }
    .dropzone.drag { border-color:var(--accent); background:linear-gradient(145deg,#1f2630,#171c24); }
    .dropzone input { position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; }
    .actions { display:flex; flex-wrap:wrap; gap:.9rem; align-items:center; margin-top:.2rem; }
    button.primary { background:var(--accent-grad); border:0; color:#fff; font-weight:600; letter-spacing:.5px; padding:.85rem 1.35rem; font-size:.85rem; border-radius:999px; cursor:pointer; box-shadow:0 4px 18px -4px #4f8cff55; }
    button.primary:hover { filter:brightness(1.05); box-shadow:0 5px 22px -6px #4f8cff66; }
    button.primary:active { transform:translateY(1px); }
    .progress { height:4px; width:0; background:var(--accent-grad); border-radius:4px; transition:width .35s ease; margin-top:-4px; }
  /* Result list initially hidden via panel, not the UL itself */
  /* #result { display:none; } */
    .result-card { margin:0; padding:0; list-style:none; display:flex; flex-direction:column; gap:.8rem; }
    .caption { font-size:1.1rem; font-weight:500; line-height:1.3; }
    .chips { display:flex; flex-wrap:wrap; gap:.4rem; }
    .chip { background:var(--bg); border:1px solid var(--border); padding:.35rem .65rem; border-radius:999px; font-size:.65rem; letter-spacing:.5px; font-family:var(--mono); }
    .meta { font-size:.65rem; color:var(--text-dim); letter-spacing:.5px; display:flex; gap:1rem; flex-wrap:wrap; }
    footer { margin:3rem 0 2rem; font-size:.65rem; text-align:center; color:var(--text-dim); }
    code.inline { background:var(--bg-alt); padding:2px 6px; border-radius:6px; font-size:.7rem; }
    .error { color:#ff6b6b; font-weight:500; }
    @media (max-width:720px){ .toolbar { width:100%; justify-content:flex-start; } main { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
  <h1>clapety-clap <span aria-hidden="true">üëè</span></h1>
        <p class="lead">Drop an audio file to obtain a top‚ÄëK semantic tag ranking powered by CLAP embeddings.</p>
      </div>
      <div class="toolbar">
        <button class="switch" id="themeToggle" title="Toggle theme">THEME</button>
      </div>
    </header>
    <main>
      <section class="panel" style="grid-column:span 2;">
        <h2>Analyze Audio</h2>
        <form id="caption-form">
          <div class="dropzone" id="dropzone">
            <strong>Drop audio here</strong>
            <span style="font-size:.7rem;color:var(--text-dim);">or click to select (wav, mp3, flac, ogg, m4a, webm)</span>
            <input type="file" name="file" accept="audio/*" required />
          </div>
          <div class="fields" style="display:grid; gap:1rem; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
            <label class="field">Top‚ÄëK
              <input type="number" name="top_k" value="3" min="1" max="50" />
            </label>
            <label class="field">Model
              <input type="text" name="model_name" value="laion/clap-htsat-fused" />
            </label>
          </div>
          <div class="actions">
            <button type="submit" class="primary" id="submitBtn">Caption</button>
            <span id="status" style="font-size:.65rem;color:var(--text-dim);"></span>
          </div>
          <div class="progress" id="progress"></div>
        </form>
      </section>
      <section class="panel" id="resultPanel" style="display:none;">
        <h2>Result</h2>
        <ul class="result-card" id="result"></ul>
      </section>
    </main>
    <footer>
      CLI usage: <code class="inline">uv run clap caption path/to/file.wav</code>
    </footer>
  </div>
  <script>
  const form = document.getElementById('caption-form');
    const resultPanel = document.getElementById('resultPanel');
    const resultList = document.getElementById('result');
    const dropzone = document.getElementById('dropzone');
    const progressEl = document.getElementById('progress');
    const statusEl = document.getElementById('status');
    const themeToggle = document.getElementById('themeToggle');
    const fileInput = dropzone.querySelector('input[type=file]');
    let busy = false;

    function setProgress(p){ progressEl.style.width = (p*100)+'%'; }
    function clearProgress(){ setProgress(0); }
    function setStatus(msg){ statusEl.textContent = msg; }

    // Theme handling with persistence
    const storedTheme = localStorage.getItem('clap_theme');
    if(storedTheme === 'light') document.body.classList.add('light');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('clap_theme', document.body.classList.contains('light') ? 'light' : 'dark');
    });

    ;['dragenter','dragover'].forEach(evt=>dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(evt=>dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('drag'); }));
    dropzone.addEventListener('drop', e=>{ const f=e.dataTransfer.files[0]; if(f){ fileInput.files = e.dataTransfer.files; autoSubmit(); } });
    fileInput.addEventListener('change', ()=>{ if(fileInput.files.length) autoSubmit(); });

    async function runInference(){
      if(busy) return;
      if(!fileInput.files.length){ fileInput.focus(); return; }
      busy = true;
      resultPanel.style.display='block';
      resultList.innerHTML = '<li style="font-size:.75rem;color:var(--text-dim);">Processing...</li>';
      setStatus('Uploading...');
      setProgress(.2);
      const fd = new FormData(form);
      try {
        const res = await fetch('/api/caption', { method:'POST', body: fd });
        setProgress(.6);
        if(!res.ok){ const txt = await res.text(); throw new Error(res.status+': '+txt); }
        const data = await res.json();
        setProgress(1); setStatus('Done');
  const chips = data.tags.map(t=>`<span class="chip">${t}</span>`).join('');
        resultList.innerHTML = `
          <li class="caption">${data.caption}</li>
          <li class="chips">${chips}</li>
          <li class="meta"><span>Model: ${data.model}</span><span>Top‚ÄëK: ${data.top_k}</span><span>File: ${data.filename}</span></li>`;
  // ensure list visible if any user agents cached old CSS
  resultList.style.display='flex';
      } catch(err){
        setProgress(0); setStatus('Error');
        resultList.innerHTML = `<li class="error">${err.message}</li>`;
      } finally {
        setTimeout(clearProgress, 1500); busy = false;
      }
    }

    function autoSubmit(){ setTimeout(()=>runInference(), 60); }
    form.addEventListener('submit', e=>{ e.preventDefault(); runInference(); });
  </script>
</body>
</html>
